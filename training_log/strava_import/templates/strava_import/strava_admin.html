{% extends 'base.html' %}
{% load bootstrap5 %}

{% block title %}Get strava data{% endblock title %}

{% block content %}
{% autoescape off %}
<h1>Strava Admin</h1>

{% if strava_subscribed %}
<p class="ok">Strava is subscribed. <a href="{% url 'strava-subscribe' 0 %}?next=/">Unsubscribe</a></p>
{% else %}
<p class="highlight">Strava is not subscribed. <a href="{% url 'strava-subscribe' 1 %}?next=/">Subscribe</a>
</p>
{% endif %}

<p>
{% bootstrap_button "Run start time update" href="strava-start-time-sync" button_class="btn btn-primary" %}
</p>

<table class="standard">
    <tr>
        <th>User</th>
        <th>Valid Token</th>
        <th>Num Sessions</th></td>
        <th>Import</th>
        <th>Update</th>
    </tr>
{% for strava_user in strava_users %}
    <tr class="standard {% cycle 'altrow' '' %} clickablerow">
        <td>{{ strava_user.user.username.capitalize }}</td>
        <td>{{ strava_user.has_valid_access_token }}</td>
        {% if strava_user.has_valid_access_token %}
            <form action="{% url 'admin-import-data' %}"  method="post">
                <input type="hidden" name="username" value="{{ strava_user.user.username }}">
                <td><input type="number" max="200" name="num_sessions" value="5" class="num_sessions"></td>
                <td><button type="submit" name="action" value="import">Import</button></td>
                {% csrf_token %}
            </form>
            <form action="{% url 'admin-athlete-update' %}" method="post">
                <input type="hidden" name="username" value="{{ strava_user.user.username }}">
                <td><button type="submit" name="action" value="update_athlete">Update Athlete</button></td>
                {% csrf_token %}
            </form>
        {% else %}
            <td></td><td></td>
        {% endif %}
    </tr>
{% endfor %}
</table>


{% if imported_sessions %}
    <p>Imported {{ imported_sessions|length }} sessions {% if days_back > 1 %} in last {{ days_back }} days{% else %} since yesterday{% endif %}.</p>
    <table class="import-table">
        <tr><th>Date</th><th>Discipline</th><th>Duration</th><th>Imported at</th></tr>
        {% for session in imported_sessions %}
            <tr>
                <td>{{ session.date|date:"d-m-y" }}</td>
                <td>{{ session.discipline }}</td>
                <td>{{ session.formatted_duration }}</td>
                <td>{{ session.strava_updated|date:"d-m-y H:i:s" }}</td>
            </tr>
        {% endfor %}
    </table>
{% else %}
    <p>No sessions imported</p>
{% endif %}




{% endautoescape %}

{% endblock content %}

